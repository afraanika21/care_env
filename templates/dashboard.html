<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f7f7f7;
            margin: 0;
            background-color: #f7f7f7;
        }

        .container {
            display: flex;
            min-height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 260px;
            background-color: #e2eee2;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-btn {
            display: block;
            background-color: #6a8f6a;
            color: white;
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            margin-bottom: 10px;
            transition: background-color 0.3s;
        }

        .sidebar-btn:hover {
            background-color: #4a6d4a;
        }

        .logout {
            text-align: center;
            color: #c0392b;
            font-weight: bold;
            text-decoration: none;
            padding: 10px 0;
            font-size: 14px;
        }

        .main-content {
            margin-left: 260px;
            flex: 1;
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #68a469;
            margin-bottom: 15px;
            margin-left: 80px;
        }

        canvas {
            max-width: 100%;
            height: auto;
            margin-left: 40px;
            padding: 20px;
        }

        .sidebar a.logout {
            margin-top: 20px;
            color: #d9534f;
            text-decoration: none;
            font-weight: bold;
            text-align: center;
        }

        .main-content {
            flex: 1;
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #68a469;
            margin-bottom: 15px;
        }

        canvas {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Sidebar Start -->
        <div class="sidebar">
            <a href="{{ url_for('profile') }}" class="sidebar-btn">Profile</a>
            <a href="{{ url_for('update_user') }}" class="sidebar-btn">Update Info</a>
            <a href="{{ url_for('logout') }}" class="logout">Logout</a>
        </div>
        <!-- Sidebar End -->

        <!-- Main Content Start -->
        <div class="main-content">
            <div class="section">
                <h2>Daily Electricity Consumption (Last 15 Days)</h2>
                <canvas id="dailyConsumptionChart"></canvas>
            </div>

            <div class="section">
                <h2>Electricity Usage Histogram</h2>
                <canvas id="electricityHistogramChart"></canvas>
            </div>

            <div class="section">
                <h2>Daily Water Consumption (Last 15 Days)</h2>
                <canvas id="dailyWaterConsumptionChart"></canvas>
            </div>

            <div class="section">
                <h2>Water Usage Histogram</h2>
                <canvas id="waterHistogramChart"></canvas>
            </div>

            <div class="section">
                <h2>Daily Gas Consumption (Last 15 Days)</h2>
                <canvas id="dailyGasConsumptionChart"></canvas>
            </div>

            <div class="section">
                <h2>Gas Usage Histogram</h2>
                <canvas id="gasHistogramChart"></canvas>
            </div>

            <div class="section">
                <h2>Daily Fuel Consumption (Last 15 Days)</h2>
                <canvas id="dailyFuelConsumptionChart"></canvas>
            </div>

            <div class="section">
                <h2>Fuel Usage Histogram</h2>
                <canvas id="fuelHistogramChart"></canvas>
            </div>

            <div class="section">
                <h2>Bills</h2>
                <a href="{{ url_for('view_electricity_bills') }}" class="btn">View Electricity Bills</a>
                <a href="{{ url_for('view_water_bills') }}" class="btn">View Water Bills</a>
                <a href="{{ url_for('view_gas_bills') }}" class="btn">View Gas Bills</a>
                <a href="{{ url_for('view_fuel_bills') }}" class="btn">View Fuel Bills</a>
            </div>

            <div class="section">
                <h2>Daily Carbon Footprint (Last 15 Days)</h2>
                <canvas id="dailyCarbonChart"></canvas>
            </div>

            <div class="section">
                <h2>Monthly Carbon Footprint</h2>
                <canvas id="carbonHistogramChart"></canvas>
            </div>


            <div class="section-card"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 60px; margin-top: 60px; margin-left: 120px;">

                <div
                    style="background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: center;">
                    <h2 style="color: #68a469;">Total Emission</h2>
                    <canvas id="totalEmissionChart" style="max-width: 250px; height: 250px; margin: 0 auto;"></canvas>
                </div>

                <div
                    style="background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: center;">
                    <h2 style="color: #68a469;">Electricity Emission</h2>
                    <canvas id="electricityEmissionChart"
                        style="max-width: 250px; height: 250px; margin: 0 auto;"></canvas>
                </div>
                <div
                    style="background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: center;">
                    <h2 style="color: #68a469;">Fuel Emission</h2>
                    <canvas id="fuelEmissionChart" style="max-width: 250px; height: 250px; margin: 0 auto;"></canvas>
                </div>
            </div>

            <div class="section-card"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 60px; margin-top: 60px; margin-right: 120px; margin-left: 240px;">

                <div
                    style="background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: center;">
                    <h2 style="color: #68a469;">Gas Emission</h2>
                    <canvas id="gasEmissionChart" style="max-width: 250px; height: 250px; margin: 0 auto;"></canvas>
                </div>
                <div
                    style="background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: center;">
                    <h2 style="color: #68a469;">Water Emission</h2>
                    <canvas id="waterEmissionChart" style="max-width: 250px; height: 250px; margin: 0 auto;"></canvas>
                </div>
            </div>

        </div>
        <!-- Main Content End -->

    </div>




    <div class="section">
        <a href="{{ url_for('update_user') }}" class="btn">Update Your Information</a>
    </div>

    <p><a href="{{ url_for('logout') }}">Logout</a></p>



    <script>
        // Get recent consumption data from the template
        const recentConsumption = {{ recent_consumption | tojson}};

        // Extract the dates, units, and bills for the graph
        const labels = recentConsumption.map(record => record.date);
        const units = recentConsumption.map(record => record.units);
        const bills = recentConsumption.map(record => record.bill);

        // Create the chart
        const ctx = document.getElementById('dailyConsumptionChart').getContext('2d');
        const dailyConsumptionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels, // Dates
                datasets: [
                    {
                        label: 'Consumed Taka (Tk)',
                        data: bills, // Daily Bills
                        borderColor: 'rgba(85, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Consumed Units (kWh)',
                        data: units, // Units Consumed
                        borderColor: 'rgba(255, 205, 86, 1)',
                        backgroundColor: 'rgba(255, 205, 86, 0.2)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Value'
                        }
                    }
                }
            }
        });
    </script>



    <script>
        // Get monthly electricity data from the backend
        const monthlyElectricityData = {{ monthly_electricity_data | tojson }};

        // Format month and year labels for histogram
        const histogramLabels = monthlyElectricityData.map(
            record => `${record.bill_month}/${record.bill_year}`
        );

        // Extract total units consumed
        const histogramData = monthlyElectricityData.map(record => record.total_units);
        const histogramBills = monthlyElectricityData.map(record => record.total_bill);

        // Create the histogram chart
        const ctxHistogram = document.getElementById('electricityHistogramChart').getContext('2d');
        const electricityHistogramChart = new Chart(ctxHistogram, {
            type: 'bar',
            data: {
                labels: histogramLabels,
                datasets: [{
                    label: 'Electricity Usage (kWh)',
                    data: histogramData,
                    backgroundColor: 'rgba(95, 192, 192, 0.6)',
                    borderColor: 'rgba(105, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const units = context.raw;
                                const index = context.dataIndex;
                                const bill = histogramBills[index];
                                return [
                                    `Units: ${units.toFixed(2)} kWh`,
                                    `Bill: ${bill.toFixed(2)} Tk`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'Month/Year' } },
                    y: { title: { display: true, text: 'Electricity Usage (kWh)' }, beginAtZero: true }
                }
            }
        });
    </script>


    <script>
        // Get recent water consumption data
        const recentWaterConsumption = {{ recent_water_consumption | tojson }};

        const waterLabels = recentWaterConsumption.map(record => record.date);
        const liters = recentWaterConsumption.map(record => record.liters);
        const waterBills = recentWaterConsumption.map(record => record.bill);

        // Create the water consumption chart
        const ctxWater = document.getElementById('dailyWaterConsumptionChart').getContext('2d');
        const dailyWaterConsumptionChart = new Chart(ctxWater, {
            type: 'line',
            data: {
                labels: waterLabels,
                datasets: [
                    {
                        label: 'Consumed Taka (Tk)',
                        data: waterBills,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Consumed Water (Liters)',
                        data: liters,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    x: { title: { display: true, text: 'Date' } },
                    y: { title: { display: true, text: 'Value' }, beginAtZero: true }
                }
            }
        });

    </script>



    <script>
        // Get monthly water data from the backend
        const monthlyWaterData = {{ monthly_water_data | tojson }};

        // Format month and year labels for water histogram
        const waterHistogramLabels = monthlyWaterData.map(
            record => `${record.month}/${record.year}`
        );

        // Extract total liters consumed
        const waterHistogramData = monthlyWaterData.map(record => record.total_liters);
        const waterHistogramBills = monthlyWaterData.map(record => record.total_bill);

        // Create the water histogram chart
        const ctxWaterHistogram = document.getElementById('waterHistogramChart').getContext('2d');
        const waterHistogramChart = new Chart(ctxWaterHistogram, {
            type: 'bar',
            data: {
                labels: waterHistogramLabels,
                datasets: [{
                    label: 'Water Usage (Liters)',
                    data: waterHistogramData,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const liters = context.raw;
                                const index = context.dataIndex;
                                const bill = waterHistogramBills[index];
                                return [
                                    `Liters: ${liters.toFixed(2)} L`,
                                    `Bill: ${bill.toFixed(2)} Tk`
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'Month/Year' } },
                    y: { title: { display: true, text: 'Water Usage (Liters)' }, beginAtZero: true }
                }
            }
        });
    </script>


    <script>
        const recentGasConsumption = {{ recent_gas_consumption | tojson }};
        const gasLabels = recentGasConsumption.map(record => record.date);
        const cubicMeters = recentGasConsumption.map(record => record.cubic_meters);
        const gasBills = recentGasConsumption.map(record => record.bill);

        const ctxGas = document.getElementById('dailyGasConsumptionChart').getContext('2d');
        const dailyGasConsumptionChart = new Chart(ctxGas, {
            type: 'line',
            data: {
                labels: gasLabels,
                datasets: [
                    {
                        label: 'Gas Cost (Tk)',
                        data: gasBills,
                        borderColor: 'rgba(255, 159, 64, 1)',
                        backgroundColor: 'rgba(255, 159, 64, 0.2)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Gas Used (Cubic Meters)',
                        data: cubicMeters,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    x: { title: { display: true, text: 'Date' } },
                    y: { title: { display: true, text: 'Value' }, beginAtZero: true }
                }
            }
        });

    </script>


    <script>
        const monthlyGasData = {{ monthly_gas_data | tojson }};
        const gasHistogramLabels = monthlyGasData.map(record => `${record.month}/${record.year}`);
        const gasHistogramData = monthlyGasData.map(record => record.total_cubic_meters);
        const gasHistogramBills = monthlyGasData.map(record => record.total_bill);

        const ctxGasHistogram = document.getElementById('gasHistogramChart').getContext('2d');
        const gasHistogramChart = new Chart(ctxGasHistogram, {
            type: 'bar',
            data: {
                labels: gasHistogramLabels,
                datasets: [{
                    label: 'Gas Usage (Cubic Meters)',
                    data: gasHistogramData,
                    backgroundColor: 'rgba(255, 159, 64, 0.6)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const usage = context.raw;
                                const index = context.dataIndex;
                                const bill = gasHistogramBills[index];
                                return [`Gas Used: ${usage.toFixed(2)} m³`, `Bill: ${bill.toFixed(2)} Tk`];
                            }
                        }
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'Month/Year' } },
                    y: { title: { display: true, text: 'Gas Usage (m³)' }, beginAtZero: true }
                }
            }
        });
    </script>

    <script>
        const recentFuelConsumption = {{ recent_fuel_consumption | tojson }};
        const fuelLabels = recentFuelConsumption.map(record => record.date);
        const fuelLiters = recentFuelConsumption.map(record => record.liters);
        const fuelBills = recentFuelConsumption.map(record => record.bill);

        const ctxFuel = document.getElementById('dailyFuelConsumptionChart').getContext('2d');
        const dailyFuelConsumptionChart = new Chart(ctxFuel, {
            type: 'line',
            data: {
                labels: fuelLabels,
                datasets: [
                    {
                        label: 'Fuel Cost (Tk)',
                        data: fuelBills,
                        borderColor: 'rgba(153, 102, 255, 1)',
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Fuel Used (Liters)',
                        data: fuelLiters,
                        borderColor: 'rgba(201, 203, 207, 1)',
                        backgroundColor: 'rgba(201, 203, 207, 0.2)',
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    x: { title: { display: true, text: 'Date' } },
                    y: { title: { display: true, text: 'Value' }, beginAtZero: true }
                }
            }
        });

    </script>

    <script>
        const monthlyFuelData = {{ monthly_fuel_data | tojson }};
        const fuelHistogramLabels = monthlyFuelData.map(record => `${record.month}/${record.year}`);
        const fuelHistogramData = monthlyFuelData.map(record => record.total_liters);
        const fuelHistogramBills = monthlyFuelData.map(record => record.total_bill);

        const ctxFuelHistogram = document.getElementById('fuelHistogramChart').getContext('2d');
        const fuelHistogramChart = new Chart(ctxFuelHistogram, {
            type: 'bar',
            data: {
                labels: fuelHistogramLabels,
                datasets: [{
                    label: 'Fuel Usage (Liters)',
                    data: fuelHistogramData,
                    backgroundColor: 'rgba(153, 102, 255, 0.6)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                const usage = context.raw;
                                const index = context.dataIndex;
                                const bill = fuelHistogramBills[index];
                                return [`Liters: ${usage.toFixed(2)} L`, `Bill: ${bill.toFixed(2)} Tk`];
                            }
                        }
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'Month/Year' } },
                    y: { title: { display: true, text: 'Fuel Usage (Liters)' }, beginAtZero: true }
                }
            }
        });
    </script>

    <script>
        const recentCarbon = {{ recent_carbon_footprint | tojson }};

        const carbonLabels = recentCarbon.map(record => record.date);
        const carbonKg = recentCarbon.map(record => record.carbon_kg);

        const ctxCarbon = document.getElementById('dailyCarbonChart').getContext('2d');
        const dailyCarbonChart = new Chart(ctxCarbon, {
            type: 'line',
            data: {
                labels: carbonLabels,
                datasets: [{
                    label: 'Daily CO₂ Emissions (kg)',
                    data: carbonKg,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    x: { title: { display: true, text: 'Date' } },
                    y: { title: { display: true, text: 'CO₂ Emissions (kg)' }, beginAtZero: true }
                }
            }
        });
    </script>



    <script>
        const monthlyCarbon = {{ monthly_carbon_data | tojson }};
        const carbonHistogramLabels = monthlyCarbon.map(record => `${record.month}/${record.year}`);
        const monthlyCarbonKg = monthlyCarbon.map(record => record.total_carbon_kg);

        const ctxCarbonHistogram = document.getElementById('carbonHistogramChart').getContext('2d');
        const carbonHistogramChart = new Chart(ctxCarbonHistogram, {
            type: 'bar',
            data: {
                labels: carbonHistogramLabels,
                datasets: [{
                    label: 'Monthly CO₂ Emissions (kg)',
                    data: monthlyCarbonKg,
                    backgroundColor: 'rgba(153, 102, 255, 0.6)',
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: { title: { display: true, text: 'Month/Year' } },
                    y: { title: { display: true, text: 'CO₂ (kg)' }, beginAtZero: true }
                }
            }
        });
    </script>

    <script>
        const monthlyCarbonDetailedData = {{ monthly_carbon_detailed_data | tojson }};
        const safeLimits = {{ safe_limits | tojson }};

        const latestData = monthlyCarbonDetailedData.length > 0 ? monthlyCarbonDetailedData[0] : null;

        if (latestData) {
            const electricityEmitted = latestData.total_electricity_kg || 0;
            const fuelEmitted = latestData.total_fuel_kg || 0;
            const gasEmitted = latestData.total_gas_kg || 0;
            const waterEmitted = latestData.total_water_kg || 0;
            const totalEmitted = latestData.total_carbon_kg || 0;

            const electricitySafe = safeLimits.electricity;
            const fuelSafe = safeLimits.fuel;
            const gasSafe = safeLimits.gas;
            const waterSafe = safeLimits.water;
            const totalSafe = safeLimits.total;

            function createStyledDoughnut(ctxId, emitted, safeLimit) {
                const percentageUsed = Math.min(100, (emitted / safeLimit) * 100);
                const percentageRemaining = 100 - percentageUsed;

                const ctx = document.getElementById(ctxId).getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Your Emissions', 'Remaining Safe Limit'],
                        datasets: [{
                            data: [percentageUsed, percentageRemaining],
                            backgroundColor: [
                                percentageUsed >= 80 ? 'rgba(255, 99, 132, 0.7)' :
                                    percentageUsed >= 50 ? 'rgba(255, 205, 86, 0.7)' :
                                        'rgba(75, 192, 192, 0.7)',
                                'rgba(200, 200, 200, 0.3)'
                            ],
                            borderColor: [
                                percentageUsed >= 80 ? 'rgba(255, 99, 132, 1)' :
                                    percentageUsed >= 50 ? 'rgba(255, 205, 86, 1)' :
                                        'rgba(75, 192, 192, 1)',
                                'rgba(200, 200, 200, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        cutout: '70%',
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return context.label + ': ' + context.raw.toFixed(1) + '%';
                                    }
                                }
                            },
                            legend: {
                                display: true,
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            createStyledDoughnut('electricityEmissionChart', electricityEmitted, electricitySafe);
            createStyledDoughnut('fuelEmissionChart', fuelEmitted, fuelSafe);
            createStyledDoughnut('gasEmissionChart', gasEmitted, gasSafe);
            createStyledDoughnut('waterEmissionChart', waterEmitted, waterSafe);
            createStyledDoughnut('totalEmissionChart', totalEmitted, totalSafe);
        }
    </script>


</body>

</html>