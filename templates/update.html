<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px auto;
            max-width: 1000px;
            line-height: 1.6;
            background-color: #f4f4f4;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        h1,
        h2,
        h3 {
            color: #333;
            text-align: center;
        }

        form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
            color: #333;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            background-color: #007BFF;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }

        button:hover {
            background-color: #0056b3;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 8px 12px;
            border: 1px solid #ccc;
            text-align: center;
        }

        #car_list {
            list-style-type: none;
            padding: 0;
        }

        #car_list li {
            padding: 5px;
            background: #eee;
            margin: 5px 0;
            border-radius: 4px;
            cursor: pointer;
        }

        #car_list li:hover {
            background: #ddd;
        }
    </style>
</head>

<body>
    <h1>Welcome, {{ user['name'] }}!</h1>
    <p>Your email: {{ user['email'] }}</p>

    <h2>Update Your Information</h2>

    <form action="{{ url_for('update_user') }}" method="POST">

        <!-- Basic Info -->
        <label>Phone Number:</label>
        <input type="text" name="phone" placeholder="Enter your phone number">

        <label>Address:</label>
        <textarea name="address" placeholder="Enter your address"></textarea>

        <label>Division:</label>
        <select name="division" id="division" onchange="loadProviders()">
            <option value="" disabled selected>Select your division</option>
            <option value="Dhaka">Dhaka</option>
            <option value="Chattogram">Chattogram</option>
            <option value="Khulna">Khulna</option>
            <option value="Rajshahi">Rajshahi</option>
            <option value="Barishal">Barishal</option>
            <option value="Sylhet">Sylhet</option>
            <option value="Rangpur">Rangpur</option>
            <option value="Mymensingh">Mymensingh</option>
        </select>

        <label>Electricity Provider:</label>
        <select id="electricity_provider" name="electricity_provider">
            <option value="" disabled selected>Select electricity provider</option>
        </select>

        <label>Water Provider:</label>
        <select id="water_provider" name="water_provider">
            <option value="" disabled selected>Select water provider</option>
        </select>

        <label>Gas Provider:</label>
        <select id="gas_provider" name="gas_provider">
            <option value="" disabled selected>Select gas provider</option>
        </select>

        <label>Gas Type:</label>
        <select id="gas_type" name="gas_type">
            <option value="" disabled selected>Select gas type</option>
            <option value="metered">Metered</option>
            <option value="non-metered">Non-metered</option>
        </select>

        <!-- Vehicles Section -->
        <h2>Your Vehicles</h2>

        <input type="text" id="car_search" oninput="searchCars()" placeholder="Search car models">
        <ul id="car_list"></ul>

        <button type="button" onclick="addCarToTable('', 'New Vehicle')">Add New Vehicle</button>

        <table id="vehicle_table">
            <thead>
                <tr>
                    <th>Model Name</th>
                    <th>Purchase Date</th>
                    <th>Custom Daily KM</th>
                    <th>License Plate</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be added dynamically -->
            </tbody>
        </table>

        <input type="hidden" name="deleted_vehicle_ids" id="deleted_vehicle_ids">

        <!-- Housing Information -->
        <h2>Housing Information</h2>
        <div class="form-group">
            <label>House Size (sqft):</label>
            <input type="number" name="house_size_sqft" value="{{ housing.house_size_sqft }}"
                placeholder="Enter house size in sqft" required>
        </div>

        <div class="form-group">
            <label>Number of Members:</label>
            <input type="number" name="num_members" value="{{ housing.num_members }}"
                placeholder="Enter number of members" required>
        </div>

        <div class="form-group">
            <label>Solar Panel Wattage:</label>
            <input type="number" name="solar_panel_watt" value="{{ housing.solar_panel_watt }}"
                placeholder="Enter solar panel wattage">
        </div>

        <div class="form-group">
            <label>Wind Source Wattage:</label>
            <input type="number" name="wind_source_watt" value="{{ housing.wind_source_watt }}"
                placeholder="Enter wind source wattage">
        </div>

        <div class="form-group">
            <label>Other Renewable Source Wattage:</label>
            <input type="number" name="other_renewable_source" value="{{ housing.other_renewable_source }}"
                placeholder="Enter other renewable source wattage">
        </div>

        <button type="submit">Update Information</button>
    </form>

    <p><a href="{{ url_for('logout') }}">Logout</a></p>

    <script>
        window.onload = function () {
            let vehicleCounter = 0;
            const deletedIds = new Set();

            function loadProviders() {
                const division = document.getElementById('division').value;
                fetch(`/get_providers/${division}`)
                    .then(response => response.json())
                    .then(data => {
                        ['electricity_provider', 'water_provider', 'gas_provider'].forEach(type => {
                            const select = document.getElementById(type);
                            select.innerHTML = '<option value="" disabled selected>Select provider</option>';
                        });
                        data.providers.forEach(provider => {
                            const option = document.createElement('option');
                            option.value = provider.id;
                            option.textContent = provider.provider_name;
                            if (provider.energy_type === 'electricity') document.getElementById('electricity_provider').appendChild(option);
                            else if (provider.energy_type === 'water') document.getElementById('water_provider').appendChild(option);
                            else if (provider.energy_type === 'gas') document.getElementById('gas_provider').appendChild(option);
                        });
                    })
                    .catch(err => console.error('Error loading providers:', err));
            }

            function searchCars() {
            const query = document.getElementById('car_search').value;
            const carList = document.getElementById('car_list');
            
            if (query.length < 2) {
                carList.style.display = 'none';
                return;
            }
            
            fetch(`/search_cars?q=${encodeURIComponent(query)}`)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    carList.innerHTML = '';
                    
                    if (data.cars && data.cars.length > 0) {
                        data.cars.forEach(car => {
                            const li = document.createElement('li');
                            li.textContent = car.model_name;
                            li.onclick = () => {
                                addCarToTable(car.id, car.model_name);
                                carList.style.display = 'none';
                                document.getElementById('car_search').value = '';
                            };
                            carList.appendChild(li);
                        });
                        carList.style.display = 'block';
                    } else {
                        carList.style.display = 'none';
                    }
                })
                .catch(err => {
                    console.error('Error searching cars:', err);
                    carList.style.display = 'none';
                });
        }

            function addCarToTable(vehicleId, modelName, purchaseDate = '', customDailyKm = '', licensePlate = '', userVehicleId = '') {
            const tbody = document.querySelector('#vehicle_table tbody');
            const row = document.createElement('tr');
            const counter = vehicleCounter++;

            row.innerHTML = `
                <td>${modelName}
                    <input type="hidden" name="vehicle_model_name_${counter}" value="${modelName}">
                    <input type="hidden" name="vehicle_vehicle_id_${counter}" value="${vehicleId}">
                    <input type="hidden" name="vehicle_user_vehicle_id_${counter}" value="${userVehicleId}">
                </td>
                <td><input type="date" name="purchase_date_${counter}" value="${purchaseDate}"></td>
                <td><input type="number" name="custom_daily_km_${counter}" value="${customDailyKm}" placeholder="KM"></td>
                <td><input type="text" name="license_plate_${counter}" value="${licensePlate}" placeholder="License"></td>
                <td><button type="button" onclick="window.removeVehicleRow(this, '${userVehicleId}')">Delete</button></td>
            `;

            tbody.appendChild(row);
            document.getElementById('car_list').innerHTML = '';
        }

            window.removeVehicleRow = function(btn, userVehicleId) {
            if (userVehicleId && userVehicleId !== 'undefined') {
                deletedIds.add(userVehicleId);
                document.getElementById('deleted_vehicle_ids').value = Array.from(deletedIds).join(',');
            }
            btn.closest('tr').remove();
        };

            // Initialize existing vehicles
            {% if user_vehicles %}
            const userVehicles = {{ user_vehicles| tojson
        }};
        userVehicles.forEach(v => {
            addCarToTable(
                v.vehicle_id,
                v.model_name,
                v.purchase_date ? v.purchase_date.split('T')[0] : '',
                v.custom_daily_km || '',
                v.license_plate || '',
                v.user_vehicle_id  // Make sure this matches your data structure
            );
        });
        {% endif %}

        // Close car list when clicking outside
        document.addEventListener('click', function (e) {
            if (!e.target.closest('#car_search') && !e.target.closest('#car_list')) {
                document.getElementById('car_list').style.display = 'none';
            }
        });

        // Attach to global for access
        window.loadProviders = loadProviders;
        window.searchCars = searchCars;
        window.addCarToTable = addCarToTable;
    };
    </script>
</body>

</html>